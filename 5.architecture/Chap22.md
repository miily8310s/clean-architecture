# 第２２章 クリーンアーキテクチャ

- システムアーキテクチャの様々なアイデアが過去数十年で出てきた
  - ヘクサゴナルアーキテクチャ
  - DCI アーキテクチャ
  - BCE
- これらのアーキテクチャは細かい違いはあれど、非常によく似ている
  - 「関心事の分離」という同じ目的を持つ
  - 少なくても、ビジネスルールのレイヤーと、ユーザーやシステムとのインターフェースとなるレイヤーを持つ
- さらに以下の特性を持つシステムを生み出す

  - フレームワーク非依存
  - テスト可能：データベース/Web サーバなど外部要素がなくてもテスト出来る
  - UI 非依存：システムの他の部分を変更することなく、簡単に変更できる
  - データベース非依存：Oracle DB や SQL Server を Mongo DB、Postgresql などに置き換えられる
  - 外部エージェント非依存

- いつもの同心円
  ![例の図](https://blog.cleancoder.com/uncle-bob/images/2012-08-13-the-clean-architecture/CleanArchitecture.jpg)
  - 引用元： https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html

## 依存性のルール

- 同心円はソフトウェアのさまざまな領域を表している
- 円の中央に近づくほどソフトウェアのレベルが上っていく
- アーキテクチャを動作させる最も重要なルールは、**依存性のルール**
- 円の内側が外側について何も知らない＆外から影響は受けない

### エンティティ

- エンティティは、企業全体の最重要ビジネスルールをカプセル化したもの
- 入るものは、メソッドを持ったオブジェクトでも、データ構造や関数でも構わない
  - ※フロントエンドなら、TS の型定義を入れるのが正かもしれない

### ユースケース

- ユースケース層には、**アプリケーション固有**のビジネスルールが含まれている
  - システムのすべてのユースケースがカプセル化・実装されている

### インターフェースアダプター

- インターフェースアダプター層は、ユースケースやエンティティのフォーマットから、データベースやウェブなどの外部エージェントのフォーマットにデータを変化するアダプター
- プレゼンター、ビュー、コントローラーは、すべて本層に属している
  - ※フロントエンドでいう本層は axios などを使用した fetch 系メソッドが該当すると思われる

### フレームワークとドライバ

- 同心円の最も外側の円は、フレームワークやツールで構成されている
  - 例）データベースやウェブフレームワークなど

### １つの円だけ？

- 同心円で示した４つ以外にも必要なものは追加しても構わない
- ただし常にソースコードの依存性は内側に向けるべき

### 境界線を超える

- インターフェースアダプター層（コントローラー/プレゼンター）は、次のユースケース層と通信している
- コントローラーから、ユースケースを経由して、最後にプレゼンターで実行される
- それぞれが内側のユースケースに向かっている
- こうした明らかな対立は、通常は依存関係逆転の原則（DIP）を使って解消する

### 境界線を超えるデータ

- 境界線を超えてデータを渡すときは、常に内側の円にとって便利な形式にする

## まとめ

- ソフトウェアをレイヤーに分割して、依存性のルールを守れば、本質的にテスト可能なシステムを作り、それがもたらすメリットを受け取ることができる
- システムの外部のパーツ（データベースやウェブフレームワーク）が廃れたとしても、そうした要素を最小限の労力で置き換えることが出来る
